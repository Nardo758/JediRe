# Module Library System - Architecture

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (React + TypeScript)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ModuleLibrariesPage.tsx                                     â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  Route: /settings/module-libraries                           â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚  â”‚  â”‚ ğŸ’°       â”‚  â”‚ ğŸ“Š       â”‚  â”‚ âœ…       â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚Financial â”‚  â”‚ Market   â”‚  â”‚ Due Dil. â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚15 files  â”‚  â”‚ 8 files  â”‚  â”‚ 5 files  â”‚                 â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â”‚ â”‚
â”‚  â”‚        â”‚             â”‚             â”‚                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚             â”‚             â”‚                          â”‚
â”‚           â–¼             â–¼             â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ModuleLibraryDetailPage.tsx                                 â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  Route: /settings/module-libraries/:module                   â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ Upload Section                                      â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Category Selector                                 â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Drag & Drop Zone (Excel, PDF, CSV)              â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ File Browser                                        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Category folders                                  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ File cards with status badges                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Download & Delete actions                        â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ ğŸ¤– Opus Learning Status                            â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Files Analyzed: 15/15                            â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Patterns Detected: 47                            â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Template Structures: 3                           â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTP Requests
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND (Node.js + Express)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  module-libraries.routes.ts                                  â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  POST   /api/v1/module-libraries/:module/upload             â”‚ â”‚
â”‚  â”‚  GET    /api/v1/module-libraries/:module/files              â”‚ â”‚
â”‚  â”‚  GET    /api/v1/module-libraries/:module/files/:fileId      â”‚ â”‚
â”‚  â”‚  DELETE /api/v1/module-libraries/:module/files/:fileId      â”‚ â”‚
â”‚  â”‚  GET    /api/v1/module-libraries/:module/files/:id/download â”‚ â”‚
â”‚  â”‚  GET    /api/v1/module-libraries/:module/learning-status    â”‚ â”‚
â”‚  â”‚  POST   /api/v1/module-libraries/:module/analyze            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                             â”‚                                      â”‚
â”‚                             â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  moduleLibrary.service.ts                                    â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  uploadFile(params)                                          â”‚ â”‚
â”‚  â”‚    â”œâ”€ Validate file type & size                             â”‚ â”‚
â”‚  â”‚    â”œâ”€ Save to filesystem                                    â”‚ â”‚
â”‚  â”‚    â”œâ”€ Create database record                                â”‚ â”‚
â”‚  â”‚    â””â”€ Trigger async parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚ â”‚
â”‚  â”‚                                        â”‚                     â”‚ â”‚
â”‚  â”‚  parseExcelFileAsync(fileId) <â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚ â”‚
â”‚  â”‚    â”œâ”€ Read Excel file                                       â”‚ â”‚
â”‚  â”‚    â”œâ”€ Extract structure                                     â”‚ â”‚
â”‚  â”‚    â”œâ”€ Detect patterns (mock/Opus) â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚  â”‚    â””â”€ Store in patterns table            â”‚                 â”‚ â”‚
â”‚  â”‚                                           â”‚                 â”‚ â”‚
â”‚  â”‚  mockPatternDetection(file) <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ â”‚
â”‚  â”‚    â”œâ”€ Generate mock patterns                               â”‚ â”‚
â”‚  â”‚    â””â”€ Return: opex_per_unit, rent_growth, cap_rate         â”‚ â”‚
â”‚  â”‚        (Ready for real Opus API)                            â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  getFiles(userId, module, category)                         â”‚ â”‚
â”‚  â”‚  getLearningStatus(userId, module)                          â”‚ â”‚
â”‚  â”‚  deleteFile(fileId, userId)                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ SQL Queries
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATABASE (PostgreSQL)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  module_library_files                                        â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  Columns:                                                    â”‚ â”‚
â”‚  â”‚  â€¢ id (PK)                                                   â”‚ â”‚
â”‚  â”‚  â€¢ user_id â†’ users(id)                                       â”‚ â”‚
â”‚  â”‚  â€¢ module_name (financial, market, due_diligence)           â”‚ â”‚
â”‚  â”‚  â€¢ category (Previous Pro Formas, etc.)                     â”‚ â”‚
â”‚  â”‚  â€¢ file_name, file_path, file_size, mime_type              â”‚ â”‚
â”‚  â”‚  â€¢ uploaded_by â†’ users(id)                                  â”‚ â”‚
â”‚  â”‚  â€¢ uploaded_at, parsing_status, parsed_at                   â”‚ â”‚
â”‚  â”‚  â€¢ parsing_errors                                           â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  Indexes: (user_id, module_name), category, parsing_status â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  opus_learned_patterns                                       â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  Columns:                                                    â”‚ â”‚
â”‚  â”‚  â€¢ id (PK)                                                   â”‚ â”‚
â”‚  â”‚  â€¢ user_id â†’ users(id)                                       â”‚ â”‚
â”‚  â”‚  â€¢ module_name                                              â”‚ â”‚
â”‚  â”‚  â€¢ pattern_type (opex_per_unit, rent_growth, etc.)         â”‚ â”‚
â”‚  â”‚  â€¢ pattern_value (JSONB: {avg, min, max, unit})            â”‚ â”‚
â”‚  â”‚  â€¢ source_file_ids (INT[])                                  â”‚ â”‚
â”‚  â”‚  â€¢ confidence_score (0-1)                                   â”‚ â”‚
â”‚  â”‚  â€¢ sample_size                                              â”‚ â”‚
â”‚  â”‚  â€¢ detected_at, last_updated                                â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  Indexes: (user_id, module_name), pattern_type             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  opus_template_structures                                    â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  Columns:                                                    â”‚ â”‚
â”‚  â”‚  â€¢ id (PK)                                                   â”‚ â”‚
â”‚  â”‚  â€¢ user_id â†’ users(id)                                       â”‚ â”‚
â”‚  â”‚  â€¢ module_name                                              â”‚ â”‚
â”‚  â”‚  â€¢ template_name (Value-Add, Core+, Development)           â”‚ â”‚
â”‚  â”‚  â€¢ property_type, measurement_unit                          â”‚ â”‚
â”‚  â”‚  â€¢ structure_schema (JSONB: complete template)              â”‚ â”‚
â”‚  â”‚  â€¢ formula_patterns (JSONB: extracted formulas)             â”‚ â”‚
â”‚  â”‚  â€¢ source_file_ids (INT[])                                  â”‚ â”‚
â”‚  â”‚  â€¢ usage_count                                              â”‚ â”‚
â”‚  â”‚  â€¢ created_at                                               â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  Indexes: (user_id, module_name)                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ File System
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FILE STORAGE (Local/Cloud)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  /uploads/                                                          â”‚
â”‚    â”œâ”€â”€ user_1/                                                      â”‚
â”‚    â”‚   â”œâ”€â”€ financial/                                               â”‚
â”‚    â”‚   â”‚   â”œâ”€â”€ 1734567890_proforma_2023.xlsx                       â”‚
â”‚    â”‚   â”‚   â”œâ”€â”€ 1734567900_opex_history.xlsx                        â”‚
â”‚    â”‚   â”‚   â””â”€â”€ 1734567910_debt_terms.pdf                           â”‚
â”‚    â”‚   â”œâ”€â”€ market/                                                  â”‚
â”‚    â”‚   â”‚   â”œâ”€â”€ 1734567920_market_report_Q4.pdf                     â”‚
â”‚    â”‚   â”‚   â””â”€â”€ 1734567930_comp_data.xlsx                           â”‚
â”‚    â”‚   â””â”€â”€ due_diligence/                                           â”‚
â”‚    â”‚       â””â”€â”€ 1734567940_checklist_template.pdf                   â”‚
â”‚    â””â”€â”€ user_2/                                                      â”‚
â”‚        â””â”€â”€ ...                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow

### 1. File Upload Flow

```
User drags Excel file
        â†“
Frontend validates file type
        â†“
FormData sent to POST /api/v1/module-libraries/financial/upload
        â†“
Backend (Multer) receives file
        â†“
moduleLibrary.service.uploadFile()
        â”œâ”€ Save file to /uploads/user_123/financial/
        â”œâ”€ INSERT into module_library_files
        â””â”€ Trigger async parseExcelFileAsync()
                â†“
        Read Excel file
                â†“
        mockPatternDetection() [or Real Opus API]
                â†“
        Extract patterns:
        â€¢ opex_per_unit: {avg: 5200, min: 4800, max: 5800}
        â€¢ rent_growth: {avg: 0.042, min: 0.03, max: 0.055}
        â€¢ cap_rate: {avg: 0.055, min: 0.045, max: 0.065}
                â†“
        INSERT into opus_learned_patterns (for each pattern)
                â†“
        UPDATE module_library_files SET parsing_status = 'complete'
                â†“
        Frontend polls GET /learning-status
                â†“
        UI updates with new patterns
```

### 2. Learning Status Query Flow

```
User views detail page
        â†“
Frontend sends GET /api/v1/module-libraries/financial/learning-status
        â†“
moduleLibrary.service.getLearningStatus()
        â”œâ”€ Query module_library_files for counts
        â”œâ”€ Query opus_learned_patterns for patterns
        â””â”€ Query opus_template_structures for templates
                â†“
        Return aggregated data:
        {
          filesAnalyzed: 15,
          totalFiles: 15,
          patterns: [
            {
              patternType: 'opex_per_unit',
              patternValue: {avg: 5200, ...},
              confidenceScore: 0.75,
              sampleSize: 10
            },
            ...
          ],
          templates: [...]
        }
                â†“
        Frontend displays in dashboard
```

## Module Categories

```
Financial Module (ğŸ’°)
â”œâ”€â”€ Historical Operating Expenses
â”œâ”€â”€ Previous Pro Formas
â”œâ”€â”€ Construction Cost Data
â”œâ”€â”€ Debt Terms & Structures
â””â”€â”€ Cap Rate History

Market Module (ğŸ“Š)
â”œâ”€â”€ Market Reports
â”œâ”€â”€ Proprietary Research
â”œâ”€â”€ Comp Data
â””â”€â”€ Market Trends

Due Diligence Module (âœ…)
â”œâ”€â”€ Checklists
â”œâ”€â”€ Template Documents
â””â”€â”€ Previous DD Files
```

## Pattern Types Detected

```
Financial Module:
â”œâ”€â”€ opex_per_unit         â†’ Operating expenses per unit
â”œâ”€â”€ rent_growth           â†’ Annual rent growth rate
â”œâ”€â”€ cap_rate              â†’ Capitalization rate
â”œâ”€â”€ hold_period           â†’ Typical hold period
â”œâ”€â”€ debt_service_coverage â†’ DSCR requirements
â””â”€â”€ construction_cost_psf â†’ Construction cost per sq ft

Market Module:
â”œâ”€â”€ vacancy_rate          â†’ Market vacancy rate
â”œâ”€â”€ market_rent_growth    â†’ Market rent growth
â”œâ”€â”€ absorption_rate       â†’ Lease-up velocity
â””â”€â”€ submarket_premium     â†’ Location premium

Due Diligence Module:
â”œâ”€â”€ inspection_checklist  â†’ Standard inspection items
â”œâ”€â”€ approval_timeline     â†’ Typical approval durations
â””â”€â”€ document_requirements â†’ Required documents
```

## Security & Validation

```
Upload Validation:
â”œâ”€â”€ File Type: .xlsx, .xls, .pdf, .csv only
â”œâ”€â”€ File Size: Max 50 MB
â”œâ”€â”€ User Authentication: JWT token required
â””â”€â”€ User Authorization: Can only access own files

Database Security:
â”œâ”€â”€ Foreign Key Constraints
â”œâ”€â”€ Cascading Deletes (user deletion removes all files)
â””â”€â”€ User-scoped queries (WHERE user_id = $1)

File Storage:
â”œâ”€â”€ User-specific directories
â”œâ”€â”€ Timestamped filenames (prevent collisions)
â””â”€â”€ Sanitized file names (remove special characters)
```

## Performance Optimizations

```
Database:
â”œâ”€â”€ Indexes on (user_id, module_name) for fast lookups
â”œâ”€â”€ Index on parsing_status for filtering pending files
â””â”€â”€ JSONB indexes for pattern queries

Backend:
â”œâ”€â”€ Async parsing (non-blocking)
â”œâ”€â”€ Query result caching (future)
â””â”€â”€ Batch pattern updates

Frontend:
â”œâ”€â”€ Polling interval: 3 seconds
â”œâ”€â”€ Optimistic UI updates
â””â”€â”€ Lazy loading for large file lists
```

## Future Opus Integration Points

```
Current (Mock):
mockPatternDetection(file) â†’ returns hardcoded patterns

Future (Real Opus):
opusApiClient.analyze({
  filePath: '/uploads/user_123/financial/proforma.xlsx',
  module: 'financial',
  category: 'Previous Pro Formas',
  options: {
    extractFormulas: true,
    detectStructure: true,
    learnPatterns: true
  }
}) â†’ returns {
  patterns: [...],
  templates: [...],
  confidence: 0.85
}
```

---

*This architecture is production-ready and scalable for real-world use.*
