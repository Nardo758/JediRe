import React, { useState, useEffect } from 'react';
import { useDesignDashboardStore } from '../../stores/DesignDashboardStore';
import { DollarSign, TrendingUp, Calculator, Send } from 'lucide-react';

export const FinancialSummaryPanel: React.FC = () => {
  const { designMetrics, financialSummary, updateFinancialSummary } = useDesignDashboardStore();
  const [assumptions, setAssumptions] = useState({
    costPerSF: 325,
    avgRentPerUnit: 2500,
    opexRatio: 0.35,
    capRate: 5.5,
  });

  // Calculate financial summary whenever metrics or assumptions change
  useEffect(() => {
    if (designMetrics.units > 0 && designMetrics.totalSF > 0) {
      const totalCost = designMetrics.totalSF * assumptions.costPerSF;
      const annualRent = designMetrics.units * assumptions.avgRentPerUnit * 12;
      const annualNOI = annualRent * (1 - assumptions.opexRatio);
      const returnOnCost = (annualNOI / totalCost) * 100;

      updateFinancialSummary({
        estimatedCost: totalCost,
        estimatedRevenue: annualRent,
        estimatedNOI: annualNOI,
        capRate: assumptions.capRate,
        returnOnCost: returnOnCost,
      });
    }
  }, [designMetrics, assumptions, updateFinancialSummary]);

  if (!financialSummary) {
    return (
      <div className="p-4 text-center text-gray-500">
        <Calculator className="w-8 h-8 mx-auto mb-2 text-gray-400" />
        <p className="text-sm">Design a building to see financial estimates</p>
      </div>
    );
  }

  return (
    <div className="p-4 space-y-4">
      <h3 className="font-semibold flex items-center gap-2">
        <DollarSign className="w-5 h-5 text-green-600" />
        Financial Summary
      </h3>

      {/* Quick Stats */}
      <div className="grid grid-cols-2 gap-3">
        <div className="bg-gray-50 p-3 rounded-lg">
          <div className="text-xs text-gray-600 mb-1">Total Cost</div>
          <div className="text-lg font-semibold text-gray-900">
            ${(financialSummary.estimatedCost / 1000000).toFixed(1)}M
          </div>
          <div className="text-xs text-gray-500">
            ${(financialSummary.estimatedCost / designMetrics.units).toLocaleString()}/unit
          </div>
        </div>
        
        <div className="bg-green-50 p-3 rounded-lg">
          <div className="text-xs text-gray-600 mb-1">Return on Cost</div>
          <div className="text-lg font-semibold text-green-600">
            {financialSummary.returnOnCost.toFixed(2)}%
          </div>
          <div className="text-xs text-gray-500">
            {financialSummary.capRate.toFixed(2)}% cap rate
          </div>
        </div>
      </div>

      {/* Revenue & NOI */}
      <div className="space-y-2">
        <div className="flex justify-between items-center py-2 border-b">
          <span className="text-sm text-gray-600">Annual Revenue</span>
          <span className="font-medium">${(financialSummary.estimatedRevenue / 1000000).toFixed(2)}M</span>
        </div>
        <div className="flex justify-between items-center py-2 border-b">
          <span className="text-sm text-gray-600">Annual NOI</span>
          <span className="font-medium">${(financialSummary.estimatedNOI / 1000000).toFixed(2)}M</span>
        </div>
      </div>

      {/* Assumptions */}
      <div className="border-t pt-4">
        <h4 className="text-sm font-medium mb-3 flex items-center justify-between">
          <span>Quick Assumptions</span>
          <button className="text-xs text-blue-600 hover:text-blue-700">
            Edit
          </button>
        </h4>
        <div className="space-y-2 text-sm">
          <div className="flex justify-between">
            <span className="text-gray-600">Construction Cost</span>
            <span>${assumptions.costPerSF}/SF</span>
          </div>
          <div className="flex justify-between">
            <span className="text-gray-600">Avg Rent</span>
            <span>${assumptions.avgRentPerUnit}/unit</span>
          </div>
          <div className="flex justify-between">
            <span className="text-gray-600">OpEx Ratio</span>
            <span>{(assumptions.opexRatio * 100).toFixed(0)}%</span>
          </div>
        </div>
      </div>

      {/* Per Unit Metrics */}
      <div className="border-t pt-4">
        <h4 className="text-sm font-medium mb-3">Per Unit Metrics</h4>
        <div className="space-y-2 text-sm">
          <div className="flex justify-between">
            <span className="text-gray-600">Avg Unit Size</span>
            <span>{Math.round(designMetrics.rentableSF / designMetrics.units)} SF</span>
          </div>
          <div className="flex justify-between">
            <span className="text-gray-600">Parking Ratio</span>
            <span>{designMetrics.parkingRatio.toFixed(2)} spaces/unit</span>
          </div>
          <div className="flex justify-between">
            <span className="text-gray-600">Cost per Unit</span>
            <span>${(financialSummary.estimatedCost / designMetrics.units).toLocaleString()}</span>
          </div>
        </div>
      </div>

      {/* Action Button */}
      <button className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 font-medium">
        <Send className="w-4 h-4" />
        Send to Financial Model
      </button>
      
      <p className="text-xs text-gray-500 text-center">
        These are quick estimates. Full analysis in Financial Model.
      </p>
    </div>
  );
};