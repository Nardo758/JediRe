1. Create the first migration file:

SQL

cd ~/workspace
cat > backend/src/database/migrations/012_map_layers.sql << 'EOF'
-- Migration 012: Map Layers System
-- Purpose: Store layer configurations for maps
-- Created: 2026-02-08

CREATE TABLE IF NOT EXISTS map_layers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  map_id UUID NOT NULL,
  
  name VARCHAR(255) NOT NULL,
  layer_type VARCHAR(50) NOT NULL,
  source_type VARCHAR(50) NOT NULL,
  
  visible BOOLEAN DEFAULT true,
  opacity NUMERIC(3,2) DEFAULT 1.0 CHECK (opacity >= 0 AND opacity <= 1),
  z_index INTEGER DEFAULT 0,
  
  filters JSONB DEFAULT '{}',
  style JSONB DEFAULT '{}',
  source_config JSONB DEFAULT '{}',
  
  created_by UUID,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_map_layers_map_id ON map_layers(map_id);
CREATE INDEX idx_map_layers_visible ON map_layers(visible) WHERE visible = true;
CREATE INDEX idx_map_layers_z_index ON map_layers(map_id, z_index);
CREATE INDEX idx_map_layers_source_type ON map_layers(source_type);

CREATE OR REPLACE FUNCTION update_map_layers_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER map_layers_updated_at
  BEFORE UPDATE ON map_layers
  FOR EACH ROW
  EXECUTE FUNCTION update_map_layers_updated_at();
EOF
2. Create the second migration:

SQL

cat > backend/src/database/migrations/013_map_configurations.sql << 'EOF'
-- Migration 013: Map Configurations
-- Purpose: Store saved layer configurations
-- Created: 2026-02-08

CREATE TABLE IF NOT EXISTS map_configurations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  
  name VARCHAR(255) NOT NULL,
  description TEXT,
  icon VARCHAR(50),
  
  config_type VARCHAR(50) DEFAULT 'custom',
  is_default BOOLEAN DEFAULT false,
  is_public BOOLEAN DEFAULT false,
  
  layer_config JSONB NOT NULL DEFAULT '[]',
  map_center JSONB DEFAULT '{"lng": -84.388, "lat": 33.749}',
  map_zoom NUMERIC(4,2) DEFAULT 11,
  
  view_count INTEGER DEFAULT 0,
  last_viewed_at TIMESTAMPTZ,
  
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_map_configurations_user_id ON map_configurations(user_id);
CREATE INDEX idx_map_configurations_config_type ON map_configurations(config_type);
CREATE INDEX idx_map_configurations_is_default ON map_configurations(user_id, is_default) WHERE is_default = true;
EOF
3. Now run the migrations:

shell

psql $DATABASE_URL -f backend/src/database/migrations/012_map_layers.sql
psql $DATABASE_URL -f backend/src/database/migrations/013_map_configurations.sql