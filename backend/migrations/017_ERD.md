# Deal State Machine - Entity Relationship Diagram

## Full Schema View

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                              USERS                                ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃ • id (UUID, PK)                                                   ┃
┃ • email, name                                                     ┃
┃ • created_at, updated_at                                          ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
        │                              │
        │ 1                            │ 1
        │                              │
        │ N                            │ N
        ▼                              ▼
┏━━━━━━━━━━━━━━━━━━━━━━━━┓    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃   SUBSCRIPTIONS        ┃    ┃      STATE_TRANSITIONS             ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━┫    ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃ • id (UUID, PK)        ┃    ┃ • id (UUID, PK)                    ┃
┃ • user_id (FK)         ┃    ┃ • deal_id (FK → deals)             ┃
┃ • tier                 ┃    ┃ • from_state VARCHAR(50)           ┃
┃ • max_deals            ┃    ┃ • to_state VARCHAR(50)             ┃
┃ • status               ┃    ┃ • reason TEXT                      ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━┛    ┃ • user_id (FK → users)             ┃
                              ┃ • metadata JSONB                   ┃
        ┏━━━━━━━━━━━━━━━━━━━━━┫ • transitioned_at TIMESTAMP        ┃
        ┃                     ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
        ▼ 1                                    ▲
        │                                      │
        │                                      │
        │ N                                    │ N
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃              DEALS (Enhanced)                ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃ • id (UUID, PK)                              ┃
┃ • user_id (FK → users)                       ┃
┃ • name VARCHAR(255)                          ┃
┃ • boundary GEOMETRY(POLYGON)                 ┃
┃ • project_type, project_intent               ┃
┃ • status ('active', 'archived', 'closed')    ┃
┃ • deal_category ('portfolio', 'pipeline')    ┃
┃ • development_type ('new', 'existing')       ┃
┃                                              ┃
┃ ╔═══════════════════════════════════════╗   ┃
┃ ║   STATE MACHINE (Migration 017)       ║   ┃
┃ ╠═══════════════════════════════════════╣   ┃
┃ ║ • state VARCHAR(50)                   ║   ┃
┃ ║   ├─ SIGNAL_INTAKE                    ║   ┃
┃ ║   ├─ TRIAGE                           ║   ┃
┃ ║   ├─ INTELLIGENCE_ASSEMBLY            ║   ┃
┃ ║   ├─ UNDERWRITING                     ║   ┃
┃ ║   ├─ DEAL_PACKAGING                   ║   ┃
┃ ║   ├─ EXECUTION                        ║   ┃
┃ ║   ├─ POST_CLOSE                       ║   ┃
┃ ║   ├─ MARKET_NOTE                      ║   ┃
┃ ║   ├─ STALLED                          ║   ┃
┃ ║   └─ ARCHIVED                         ║   ┃
┃ ║                                       ║   ┃
┃ ║ • state_data JSONB                    ║   ┃
┃ ║   └─ State-specific metadata          ║   ┃
┃ ║                                       ║   ┃
┃ ║ • quality_gates JSONB                 ║   ┃
┃ ║   └─ Gate status by state             ║   ┃
┃ ║                                       ║   ┃
┃ ║ • signal_confidence INT (0-100)       ║   ┃
┃ ║ • triage_score INT (0-50)             ║   ┃
┃ ╚═══════════════════════════════════════╝   ┃
┃                                              ┃
┃ • created_at, updated_at, archived_at        ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
        │                              │
        │ 1                            │ 1
        │                              │
        │ N                            │ N
        ▼                              ▼
┏━━━━━━━━━━━━━━━━━━━━━━━┓    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  DEAL_NOTIFICATIONS   ┃    ┃       DEAL_ACTIVITY                ┃
┣━━━━━━━━━━━━━━━━━━━━━━━┫    ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃ • id (UUID, PK)       ┃    ┃ • id (UUID, PK)                    ┃
┃ • deal_id (FK)        ┃    ┃ • deal_id (FK)                     ┃
┃ • user_id (FK)        ┃    ┃ • user_id (FK)                     ┃
┃ • type VARCHAR(50)    ┃    ┃ • action_type VARCHAR(50)          ┃
┃   ├─ state_change     ┃    ┃ • description TEXT                 ┃
┃   ├─ quality_gate_*   ┃    ┃ • metadata JSONB                   ┃
┃   ├─ task_due         ┃    ┃ • created_at                       ┃
┃   └─ assignment       ┃    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
┃ • message TEXT        ┃
┃ • read BOOLEAN        ┃
┃ • metadata JSONB      ┃
┃ • created_at          ┃
┃ • read_at             ┃
┗━━━━━━━━━━━━━━━━━━━━━━━┛


┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃               STATE_MACHINE_CONFIG (Reference)                    ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃ • state VARCHAR(50) PK                                            ┃
┃ • display_name VARCHAR(100)                                       ┃
┃ • description TEXT                                                ┃
┃ • color VARCHAR(20) - UI color (hex)                              ┃
┃ • icon VARCHAR(50)                                                ┃
┃ • quality_gates TEXT[] - Required gates for this state            ┃
┃ • next_states TEXT[] - Allowed transitions                        ┃
┃ • sort_order INTEGER                                              ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

---

## State Flow Visualization

```
START
  │
  ▼
┌────────────────┐
│ SIGNAL_INTAKE  │ ◄────┐
│ (Entry Point)  │      │
└────────────────┘      │
  │                     │
  │ Quality: basic_     │
  │ validation          │
  │                     │
  ▼                     │
┌────────────────┐      │
│    TRIAGE      │ ◄────┼───────────┐
│ (Prioritize)   │      │           │
└────────────────┘      │           │
  │       │             │           │
  │       └─────────────┼─────►┌────────────────┐
  │                     │      │  MARKET_NOTE   │
  │ Score: 0-50         │      │  (Track Only)  │
  │                     │      └────────────────┘
  ▼                     │            │
┌────────────────┐      │            │
│ INTELLIGENCE_  │      │            │
│   ASSEMBLY     │      │            │
│ (Research)     │      │            │
└────────────────┘      │            │
  │                     │            │
  │ Quality: comp_data, │            │
  │ market_context      │            │
  │                     │            │
  ▼                     │            │
┌────────────────┐      │            │
│ UNDERWRITING   │ ──►┌───────────┐ │
│ (Financial)    │    │  STALLED  │ │
└────────────────┘    │ (Paused)  │ │
  │                   └───────────┘ │
  │ Quality: model,         │       │
  │ risk_assessment         │       │
  │                         │       │
  ▼                         │       │
┌────────────────┐          │       │
│ DEAL_PACKAGING │ ─────────┘       │
│ (Prepare)      │                  │
└────────────────┘                  │
  │                                 │
  │ Quality: memo,                  │
  │ materials                       │
  │                                 │
  ▼                                 │
┌────────────────┐                  │
│   EXECUTION    │                  │
│ (Active Deal)  │                  │
└────────────────┘                  │
  │                                 │
  │ Quality: LOI,                   │
  │ due_diligence                   │
  │                                 │
  ▼                                 │
┌────────────────┐                  │
│   POST_CLOSE   │                  │
│ (Closed Deal)  │                  │
└────────────────┘                  │
  │                                 │
  │                                 │
  └─────────────────────────────────┘
  │
  ▼
┌────────────────┐
│   ARCHIVED     │
│ (Final State)  │
└────────────────┘
```

---

## Table Relationships Detail

### Core Relationships

**1. Users → Deals (1:N)**
- One user owns many deals
- FK: `deals.user_id → users.id`
- Cascade: `ON DELETE CASCADE`

**2. Deals → State Transitions (1:N)**
- One deal has many state transitions
- FK: `state_transitions.deal_id → deals.id`
- Cascade: `ON DELETE CASCADE`
- Tracks complete audit trail

**3. Deals → Notifications (1:N)**
- One deal generates many notifications
- FK: `deal_notifications.deal_id → deals.id`
- Cascade: `ON DELETE CASCADE`

**4. Users → Notifications (1:N)**
- One user receives many notifications
- FK: `deal_notifications.user_id → users.id`
- Cascade: `ON DELETE CASCADE`

**5. Users → State Transitions (1:N)**
- One user triggers many state transitions
- FK: `state_transitions.user_id → users.id`
- Cascade: `ON DELETE SET NULL` (keep history even if user deleted)

**6. Users → Activity (1:N)**
- One user generates many activity records
- FK: `deal_activity.user_id → users.id`
- Cascade: `ON DELETE SET NULL`

---

## JSONB Field Structures

### `deals.state_data`

Flexible storage for state-specific metadata.

**Examples:**

```json
// SIGNAL_INTAKE
{
  "source": "email",
  "broker_name": "John Smith",
  "initial_notes": "Strong cash flow potential",
  "attachments": ["email-123.pdf"]
}

// TRIAGE
{
  "priority_factors": ["good_location", "strong_cap_rate"],
  "competitive_landscape": "moderate",
  "fit_score": 8.5
}

// UNDERWRITING
{
  "proforma_completed": true,
  "cap_rate": 6.2,
  "irr": 15.3,
  "risk_level": "medium"
}
```

---

### `deals.quality_gates`

Status of quality checkpoints.

**Structure:**

```json
{
  "basic_validation": {
    "status": "passed",
    "checked_at": "2026-02-09T10:00:00Z",
    "checked_by": "user-uuid-123",
    "notes": "All required fields present"
  },
  "priority_score": {
    "status": "passed",
    "checked_at": "2026-02-09T11:30:00Z",
    "checked_by": "user-uuid-123",
    "score": 42
  },
  "comp_data": {
    "status": "pending",
    "checked_at": null,
    "checked_by": null
  }
}
```

**Status Values:**
- `pending` - Not yet checked
- `passed` - Requirements met
- `failed` - Requirements not met
- `waived` - Manually bypassed

---

### `state_transitions.metadata`

Additional context for state transitions.

**Examples:**

```json
// Standard transition
{
  "quality_gates_passed": ["basic_validation"],
  "transition_type": "automatic"
}

// Manual transition with override
{
  "quality_gates_waived": ["comp_data"],
  "waiver_reason": "Urgent deal, comps can be gathered in parallel",
  "approved_by": "user-uuid-manager"
}

// Stalled transition
{
  "stall_reason": "missing_financials",
  "expected_resume_date": "2026-03-01",
  "follow_up_assigned_to": "user-uuid-agent"
}
```

---

### `deal_notifications.metadata`

Action context for notifications.

**Examples:**

```json
// State change notification
{
  "from_state": "TRIAGE",
  "to_state": "INTELLIGENCE_ASSEMBLY",
  "reason": "High priority deal, proceeding to research",
  "action_url": "/deals/uuid-123/state-history"
}

// Quality gate failed notification
{
  "gate_name": "comp_data",
  "failure_reason": "Insufficient comparable properties",
  "required_count": 5,
  "found_count": 2,
  "action_url": "/deals/uuid-123/comps"
}

// Task due notification
{
  "task_id": "task-uuid-456",
  "task_title": "Submit rent roll to lender",
  "due_date": "2026-02-15T17:00:00Z",
  "action_url": "/deals/uuid-123/tasks/456"
}
```

---

## Index Strategy

### Deals Table

```sql
-- State machine indexes
idx_deals_state                   -- WHERE state = 'X'
idx_deals_signal_confidence       -- ORDER BY signal_confidence
idx_deals_triage_score            -- ORDER BY triage_score
idx_deals_state_data (GIN)        -- state_data @> '{"key": "value"}'
idx_deals_quality_gates (GIN)     -- quality_gates -> 'gate_name'

-- Existing indexes
idx_deals_user_id                 -- WHERE user_id = X
idx_deals_status                  -- WHERE status = 'active'
idx_deals_created_at              -- ORDER BY created_at DESC
```

### State Transitions Table

```sql
idx_state_transitions_deal_id     -- Get history for deal
idx_state_transitions_from_state  -- Analyze flow from state
idx_state_transitions_to_state    -- Analyze flow to state
idx_state_transitions_user_id     -- User activity tracking
idx_state_transitions_transitioned_at -- Time-based queries
idx_state_transitions_metadata (GIN)   -- JSONB queries
```

### Deal Notifications Table

```sql
idx_deal_notifications_deal_id    -- Notifications for deal
idx_deal_notifications_user_id    -- User's notifications
idx_deal_notifications_read       -- Unread filter
idx_deal_notifications_type       -- Group by type
idx_deal_notifications_created_at -- Chronological order
```

---

## Common Query Patterns

### 1. Get Deals by State

```sql
-- All deals in UNDERWRITING
SELECT id, name, triage_score, signal_confidence, created_at
FROM deals
WHERE state = 'UNDERWRITING'
ORDER BY triage_score DESC;
```

**Uses:** `idx_deals_state`, `idx_deals_triage_score`

---

### 2. Get Deal State History

```sql
-- Complete state history for a deal
SELECT 
  from_state,
  to_state,
  reason,
  u.email as changed_by,
  transitioned_at
FROM state_transitions st
LEFT JOIN users u ON u.id = st.user_id
WHERE st.deal_id = 'deal-uuid-123'
ORDER BY transitioned_at DESC;
```

**Uses:** `idx_state_transitions_deal_id`

---

### 3. Get Unread Notifications

```sql
-- User's unread notifications
SELECT 
  dn.id,
  dn.type,
  dn.message,
  d.name as deal_name,
  dn.created_at
FROM deal_notifications dn
JOIN deals d ON d.id = dn.deal_id
WHERE dn.user_id = 'user-uuid-456'
  AND dn.read = false
ORDER BY dn.created_at DESC;
```

**Uses:** `idx_deal_notifications_user_id`, `idx_deal_notifications_read`

---

### 4. Check Quality Gates

```sql
-- Deals with pending quality gates in current state
SELECT 
  id,
  name,
  state,
  quality_gates
FROM deals
WHERE state = 'INTELLIGENCE_ASSEMBLY'
  AND NOT (quality_gates @> '{"comp_data": {"status": "passed"}}')
ORDER BY created_at;
```

**Uses:** `idx_deals_state`, `idx_deals_quality_gates` (GIN)

---

### 5. State Transition Analytics

```sql
-- Average time in each state
SELECT 
  to_state,
  COUNT(*) as transition_count,
  AVG(
    EXTRACT(EPOCH FROM (
      LEAD(transitioned_at) OVER (PARTITION BY deal_id ORDER BY transitioned_at) - transitioned_at
    )) / 86400
  )::NUMERIC(10,2) as avg_days_in_state
FROM state_transitions
WHERE to_state NOT IN ('ARCHIVED', 'STALLED')
GROUP BY to_state
ORDER BY avg_days_in_state DESC;
```

**Uses:** `idx_state_transitions_to_state`, `idx_state_transitions_deal_id`

---

### 6. Stalled Deals Report

```sql
-- Deals stuck in early stages for >7 days
SELECT 
  id,
  name,
  state,
  triage_score,
  signal_confidence,
  EXTRACT(DAY FROM NOW() - created_at) as days_since_created,
  state_data->>'priority_factors' as priority_factors
FROM deals
WHERE state IN ('TRIAGE', 'INTELLIGENCE_ASSEMBLY')
  AND created_at < NOW() - INTERVAL '7 days'
  AND status = 'active'
ORDER BY triage_score DESC, days_since_created DESC;
```

**Uses:** `idx_deals_state`, `idx_deals_created_at`, `idx_deals_state_data` (GIN)

---

## Migration Checklist

- [x] Add state machine columns to deals table
- [x] Create state_transitions table
- [x] Create deal_notifications table
- [x] Create state_machine_config reference table
- [x] Create helper functions (transition, history, notifications)
- [x] Create triggers (auto-log state changes)
- [x] Add indexes for performance
- [x] Migrate existing deals to TRIAGE state
- [x] Add constraints and validation
- [x] Seed state_machine_config with 10 states
- [x] Grant permissions
- [x] Add comments and documentation

---

**Migration 017: Deal State Machine** ✅  
**Schema Version:** v1.0.0  
**Applied:** 2026-02-09
